# CI/CD Pipeline Documentation for FireBook

This guide explains the Continuous Integration and Continuous Deployment (CI/CD) pipelines configured for the FireBook application using GitHub Actions.

## Overview

The project includes three automated workflows:

1. **CI (Continuous Integration)** - Tests and validates every push/PR
2. **Docker Build & Push** - Builds and publishes Docker images to Docker Hub
3. **Firebase Deploy** - Deploys the application to Firebase Hosting

## Workflows

### 1. CI Workflow (`ci.yml`)

**Triggers:**
- Push to `master`, `main`, or `develop` branches
- Pull requests to `master`, `main`, or `develop` branches

**Jobs:**
- Runs on multiple Node.js versions (18.x, 20.x)
- Installs dependencies
- Builds the project
- Verifies build output (checks for required files)
- Builds Docker image (without pushing)
- Tests Docker container by running it and making HTTP request

**Status Badge:**
```markdown
![CI](https://github.com/maxjeffwell/bookmarks-capstone-api/workflows/CI/badge.svg)
```

### 2. Docker Build & Push Workflow (`docker-build-push.yml`)

**Triggers:**
- Push to `master` or `main` branch
- Git tags matching `v*` (e.g., v1.0.0)
- Manual trigger via workflow_dispatch

**Features:**
- Multi-platform builds (linux/amd64, linux/arm64)
- Automatic tagging based on branch/tag
- Docker Hub integration
- Security scanning with Trivy
- Layer caching for faster builds
- SARIF upload to GitHub Security tab

**Image Tags Generated:**
- `latest` - for default branch pushes
- `main` or `master` - branch name
- `v1.0.0` - semantic version tags
- `v1.0` - major.minor version
- `v1` - major version
- `main-abc123` - branch-commit hash

**Status Badge:**
```markdown
![Docker Build & Push](https://github.com/maxjeffwell/bookmarks-capstone-api/workflows/Docker%20Build%20%26%20Push/badge.svg)
```

### 3. Firebase Deploy Workflow (`firebase-hosting-merge.yml`)

**Triggers:**
- Push to `main` branch

**Jobs:**
- Installs dependencies
- Builds the project
- Deploys to Firebase Hosting

**Status Badge:**
```markdown
![Deploy to Firebase Hosting on merge](https://github.com/maxjeffwell/bookmarks-capstone-api/workflows/Deploy%20to%20Firebase%20Hosting%20on%20merge/badge.svg)
```

**Note:** This workflow was auto-generated by Firebase CLI and already exists in your repository.

## Required GitHub Secrets

You need to configure the following secrets in your GitHub repository:

### Setting Up Secrets

Go to: **GitHub Repository** â†’ **Settings** â†’ **Secrets and variables** â†’ **Actions** â†’ **New repository secret**

### 1. Docker Hub Credentials

**`DOCKERHUB_USERNAME`**
- Your Docker Hub username
- Example: `maxjeffwell`

**`DOCKERHUB_TOKEN`**
- Docker Hub access token (NOT your password)
- Create at: https://hub.docker.com/settings/security
- Steps:
  1. Log in to Docker Hub
  2. Go to **Account Settings** â†’ **Security**
  3. Click **New Access Token**
  4. Name: `GitHub Actions FireBook`
  5. Permissions: **Read, Write, Delete**
  6. Copy the token (shown only once!)
  7. Add to GitHub Secrets

### 2. Firebase Service Account

**`FIREBASE_SERVICE_ACCOUNT_MARMOSET_C2870`**
- Firebase service account JSON key
- Required for automated Firebase deployments
- **Note:** This secret already exists if you set up Firebase Hosting with GitHub Actions

**How to get Firebase Service Account:**

```bash
# Using Firebase CLI
cd /home/maxjeffwell/GitHub_Projects/bookmarks-capstone-api

# Login to Firebase
firebase login

# Generate service account key
firebase init hosting:github

# Follow the prompts:
# - Select your Firebase project: marmoset-c2870
# - GitHub repo: maxjeffwell/bookmarks-capstone-api
# - Authorize Firebase to access GitHub
# - This will automatically create the FIREBASE_SERVICE_ACCOUNT secret
```

Alternatively, manual setup:

1. Go to [Firebase Console](https://console.firebase.google.com/)
2. Select project: `marmoset-c2870`
3. Go to **Project Settings** â†’ **Service Accounts**
4. Click **Generate New Private Key**
5. Download the JSON file
6. Copy the entire JSON content
7. Add as `FIREBASE_SERVICE_ACCOUNT` secret in GitHub

### 3. GitHub Token (Automatic)

**`GITHUB_TOKEN`**
- Automatically provided by GitHub Actions
- No manual configuration needed
- Used for uploading security scan results

## Workflow Permissions

The workflows require specific permissions configured in the YAML files:

```yaml
permissions:
  contents: read        # Read repository contents
  packages: write       # Push Docker images to GitHub Container Registry
  security-events: write # Upload security scan results
```

## Setting Up CI/CD

### Initial Setup

1. **Add Docker Hub secrets:**
```bash
# On GitHub:
# Settings â†’ Secrets â†’ Actions â†’ New repository secret
# Add: DOCKERHUB_USERNAME
# Add: DOCKERHUB_TOKEN
```

2. **Add Firebase secret:**
```bash
# Option 1: Automated (recommended)
cd /home/maxjeffwell/GitHub_Projects/bookmarks-capstone-api
firebase init hosting:github

# Option 2: Manual
# Get service account JSON from Firebase Console
# Add as FIREBASE_SERVICE_ACCOUNT secret on GitHub
```

3. **Push workflows to GitHub:**
```bash
cd /home/maxjeffwell/GitHub_Projects/bookmarks-capstone-api

# Add workflow files
git add .github/workflows/

# Commit
git commit -m "Add CI/CD workflows with GitHub Actions"

# Push
git push origin main
```

### Verifying Setup

After pushing the workflows:

1. Go to **Actions** tab on GitHub
2. You should see three workflows:
   - âœ… CI
   - âœ… Docker Build & Push
   - âœ… Firebase Deploy

3. Click on any workflow to see execution details

## Triggering Workflows

### Automatic Triggers

**CI Workflow:**
- Automatically runs on every push to main/master/develop
- Automatically runs on every pull request

**Docker Build & Push:**
- Automatically runs on push to main/master
- Automatically runs on version tags (v1.0.0)

**Firebase Deploy:**
- Automatically runs on push to main/master

### Manual Triggers

All workflows can be manually triggered:

1. Go to **Actions** tab
2. Select the workflow
3. Click **Run workflow**
4. Choose the branch
5. Click **Run workflow** button

Or via GitHub CLI:

```bash
# Trigger CI workflow
gh workflow run ci.yml

# Trigger Docker build
gh workflow run docker-build-push.yml

# Trigger Firebase deployment
gh workflow run firebase-deploy.yml
```

## Workflow Execution Flow

### Push to Feature Branch

```
1. Developer pushes to feature branch
2. CI workflow runs:
   âœ“ Install dependencies
   âœ“ Build project
   âœ“ Verify build output
   âœ“ Build Docker image
   âœ“ Test Docker container
3. CI badge shows status
```

### Push to Main Branch

```
1. Developer merges to main
2. CI workflow runs (tests)
3. Docker Build & Push runs:
   âœ“ Build multi-platform images
   âœ“ Push to Docker Hub (maxjeffwell/firebook:latest)
   âœ“ Run security scan
   âœ“ Upload scan results
4. Firebase Deploy runs:
   âœ“ Build project
   âœ“ Deploy to Firebase Hosting
   âœ“ Update live site: https://marmoset-c2870.firebaseapp.com
5. All badges show âœ“ passing
```

### Creating Release Tag

```bash
# Create and push version tag
git tag -a v1.0.0 -m "Release version 1.0.0"
git push origin v1.0.0

# Docker Build & Push runs:
# Creates images with tags:
# - maxjeffwell/firebook:v1.0.0
# - maxjeffwell/firebook:v1.0
# - maxjeffwell/firebook:v1
# - maxjeffwell/firebook:latest
```

## Monitoring Workflows

### GitHub Actions UI

1. Go to repository **Actions** tab
2. View workflow runs (success/failure)
3. Click on run to see detailed logs
4. Download artifacts if any

### Email Notifications

GitHub sends email notifications on:
- Workflow failures
- First workflow success after previous failures

Configure at: **Profile** â†’ **Settings** â†’ **Notifications**

### Status Badges

Add to README.md to show workflow status:

```markdown
![CI](https://github.com/maxjeffwell/bookmarks-capstone-api/workflows/CI/badge.svg)
![Docker Build & Push](https://github.com/maxjeffwell/bookmarks-capstone-api/workflows/Docker%20Build%20%26%20Push/badge.svg)
![Firebase Deploy](https://github.com/maxjeffwell/bookmarks-capstone-api/workflows/Firebase%20Deploy/badge.svg)
```

## Docker Hub Integration

### Accessing Published Images

Images are published to Docker Hub:

```bash
# Pull latest image
docker pull maxjeffwell/firebook:latest

# Pull specific version
docker pull maxjeffwell/firebook:v1.0.0

# Run locally
docker run -d -p 8080:80 maxjeffwell/firebook:latest
```

### Viewing on Docker Hub

Visit: https://hub.docker.com/r/maxjeffwell/firebook

- View available tags
- See image sizes
- Check build dates
- View pull statistics

## Security Scanning

### Trivy Scanner

The Docker Build & Push workflow includes Trivy security scanning:

- Scans Docker images for vulnerabilities
- Checks for CVEs in:
  - OS packages (Alpine Linux)
  - npm dependencies
  - Application code
- Uploads results to GitHub Security tab

### Viewing Security Results

1. Go to repository **Security** tab
2. Click **Code scanning alerts**
3. Filter by **Trivy**
4. Review and dismiss/fix vulnerabilities

### Security Scan Behavior

- Runs after Docker image is built
- Does NOT block deployment (continue-on-error: true)
- Provides visibility into security issues
- Recommended to review regularly

## Troubleshooting

### CI Workflow Failures

**Issue: Build fails**
```bash
# Check locally first
npm install
npm run build
ls -la dist/

# If builds locally, check GitHub Actions logs
```

**Issue: Docker build fails**
```bash
# Test Docker build locally
docker build -t firebook:test .

# Check .dockerignore
# Verify all required files are copied
```

**Issue: Container test fails**
```bash
# Run container locally
docker run -d -p 8080:80 firebook:test
curl http://localhost:8080

# Check nginx logs
docker logs <container-id>
```

### Docker Build & Push Failures

**Issue: Authentication failed**
- Verify `DOCKERHUB_USERNAME` is correct
- Regenerate `DOCKERHUB_TOKEN` on Docker Hub
- Update GitHub secret

**Issue: Push denied**
- Check Docker Hub repository exists
- Verify token has write permissions
- Ensure repository is not private (or token has access)

**Issue: Multi-platform build fails**
- QEMU setup issue (usually transient)
- Retry the workflow
- Check GitHub Actions status page

### Firebase Deploy Failures

**Issue: Authentication failed**
- Regenerate Firebase service account
- Update `FIREBASE_SERVICE_ACCOUNT` secret
- Ensure JSON is valid (no extra spaces/newlines)

**Issue: Build succeeds but deploy fails**
- Check Firebase Hosting quota
- Verify project ID is correct: `marmoset-c2870`
- Ensure Firebase Hosting is enabled

**Issue: Deployed but site not updated**
- Check Firebase Console â†’ Hosting
- Verify deployment succeeded
- Clear browser cache
- Check CDN propagation (may take minutes)

**Issue: Wrong secret name**
- The Firebase workflow expects: `FIREBASE_SERVICE_ACCOUNT_MARMOSET_C2870`
- NOT: `FIREBASE_SERVICE_ACCOUNT`
- This was auto-generated by Firebase CLI

## Best Practices

### Branch Protection

Protect main branch:
1. Go to **Settings** â†’ **Branches**
2. Add rule for `main`
3. Enable:
   - Require status checks (CI must pass)
   - Require pull request reviews
   - Require branches to be up to date

### Semantic Versioning

Use semantic versioning for releases:

```bash
# Major version (breaking changes)
git tag -a v2.0.0 -m "Breaking: New UI design"

# Minor version (new features)
git tag -a v1.1.0 -m "Add dark mode toggle"

# Patch version (bug fixes)
git tag -a v1.0.1 -m "Fix: Login button alignment"

# Push tags
git push origin --tags
```

### Workflow Optimization

**Speed up builds:**
- Use dependency caching (already configured)
- Use Docker layer caching (already configured)
- Run jobs in parallel when possible

**Reduce costs:**
- Limit workflow runs (only on main/master for deploy)
- Use `continue-on-error` for non-critical steps
- Set timeouts for long-running jobs

## Maintenance

### Regular Tasks

**Weekly:**
- Review security scan results
- Check for failed workflows
- Monitor Docker Hub storage usage

**Monthly:**
- Update GitHub Actions versions
- Rotate secrets if needed
- Review and prune old Docker images

**Quarterly:**
- Update Node.js versions in CI matrix
- Review and update dependencies
- Audit GitHub Actions permissions

## Additional Resources

- [GitHub Actions Documentation](https://docs.github.com/en/actions)
- [Docker Build & Push Action](https://github.com/docker/build-push-action)
- [Firebase GitHub Action](https://github.com/FirebaseExtended/action-hosting-deploy)
- [Trivy Scanner](https://github.com/aquasecurity/trivy)

## Support

For issues with:
- **Workflows**: Check GitHub Actions logs and this documentation
- **Docker**: See [DOCKER.md](DOCKER.md)
- **Firebase**: See Firebase Console logs

---

ðŸ”¥ **FireBook CI/CD** - Automated builds, secure deployments, continuous delivery ðŸ”¥
